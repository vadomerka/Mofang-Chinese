{% extends "base.html" %}

{% block content %}

<form method="post" enctype="multipart/form-data">
    {{ form.hidden_tag() }}
    <div class="center-header-box">
        <h1 class="form-header">
            Введите данные слова
        </h1>
    </div>
    <div class="text-fields">
        <div class="text-field-box">
            <div class="text-field-container">
                <h2 class="text-label", id="hieroglyph-label">
                    {{ form.hieroglyph.label.text }}<span class="vnumgf required-field-span">*</span>
                </h2>
                {{ form.hieroglyph(class="form-control text-field-input", id="hieroglyph") }}
            </div>
            {% for error in form.hieroglyph.errors %}
                <p content="alert alert-danger" role="alert">
                    {{ error }}
                </p>
            {% endfor %}
        </div>
        <div class="text-field-box">
            <div class="text-field-container">
                <h2 class="text-label", id="translation-label">
                    {{ form.translation.label.text }}<span class="vnumgf required-field-span">*</span>
                </h2>
                {{ form.translation(class="form-control text-field-input", id="translation") }}
            </div>
            {% for error in form.translation.errors %}
                <p content="alert alert-danger" role="alert">
                    {{ error }}
                </p>
            {% endfor %}
        </div>
        <div class="text-field-box">
            <div class="text-field-container">
                <h2 class="text-label", id="transcription-label">
                    {{ form.transcription.label.text }}<span class="vnumgf required-field-span">*</span>
                </h2>
                {{ form.transcription(class="form-control text-field-input", id="transcription") }}
            </div>
            {% for error in form.transcription.errors %}
                <p content="alert alert-danger" role="alert">
                    {{ error }}
                </p>
            {% endfor %}
        </div>
        <div class="text-field-box">
            <div class="text-field-container">
                <h2 class="text-label", id="phrase_ch-label">
                    {{ form.phrase_ch.label.text }}<span class="vnumgf required-field-span">*</span>
                </h2>
                {{ form.phrase_ch(class="form-control text-field-input", id="phrase_ch") }}
            </div>
            {% for error in form.phrase_ch.errors %}
                <p content="alert alert-danger" role="alert">
                    {{ error }}
                </p>
            {% endfor %}
        </div>
        <div class="text-field-box">
            <div class="text-field-container">
                <h2 class="text-label", id="phrase_ru-label">
                    {{ form.phrase_ru.label.text }}<span class="vnumgf required-field-span">*</span>
                </h2>
                {{ form.phrase_ru(class="form-control text-field-input", id="phrase_ru") }}
            </div>
            {% for error in form.phrase_ru.errors %}
                <p content="alert alert-danger" role="alert">
                    {{ error }}
                </p>
            {% endfor %}
        </div>
    </div>
    <div class="center-header-box">
        <h1 class="form-header">
            Загрузите файлы для слова
        </h1>
    </div>
    <div class="file-fields-container">    
        <div class="file-fields">
            <div class="audio-file-fields">
                <div class="audio-file-line">

                    <h2>Добавьте файл озвучки транскрипции</h2>
                    <!-- <a type="button" id="audio_but" class="c-button task-audio" name="task-field">
                         <svg aria-hidden="true" focusable="false" viewBox="0 0 200 200">
                             <polygon points="67,57 67,157, 157,107" style="fill:lime;fill-rule:evenodd;"/>
                         </svg>
                     </a> -->
                    <audio id="transcription_audio_play" controls></audio>
                    <input type="file" accept="audio/*"
                           class="form-control-file" id="transcription_audio"
                           name="transcription_audio" value='{{ transcription_audio_file }}' hidden>
                    <label id="transcription_audio_button" for="transcription_audio">
                        <btn class="btn btn-white centered-button">
                            Загрузить
                        </btn>
                    </label>
                    <div class="audio-delete">
                        <input type="text" id="translation_audio_delete_input" name="translation_audio_delete_input" hidden>
                        <label id="translation_audio_delete_button-label" for="translation_audio_delete_button">
                            <btn id="translation_audio-delete-button" class="btn btn-danger btn-delete lesson-button">
                                <svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
                                    <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"></path>
                                    <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"></path>
                                </svg>
                            </btn>
                        </label>
                    </div>
                </div>
                <div class="audio-file-line">
                    <h2>Добавьте файл озвучки перевода</h2>
                    <input type="file" accept="audio/*"
                           class="form-control-file" id="translation_audio" name="translation_audio"
                           value='{{ translation_audio_file }}' hidden>
                    <label id="translation_audio_button" for="translation_audio"
                           style="min-width: 75px; min-height: 75px"
                           class="c-button">
                        <svg aria-hidden="true" focusable="false" viewBox="0 0 200 200">
                            <polygon points="67,57 67,157, 157,107"
                                     style="fill:lime;fill-rule:evenodd;"/>
                        </svg>
                    </label>
                </div>
        	    <div class="audio-file-line">
        	        <h2>Добавьте файл озвучки словосочетания</h2>
        	        <input type="file" accept="audio/*"
        	               class="form-control-file" id="phrase_audio" name="phrase_audio"
        	               value='{{ phrase_audio_file }}' hidden>
        	        <label id="phrase_audio_button" for="phrase_audio" style="min-width: 75px; min-height: 75px"
        	               class="c-button">
        	            <svg aria-hidden="true" focusable="false" viewBox="0 0 200 200">
        	                <polygon points="67,57 67,157, 157,107"
        	                         style="fill:lime;fill-rule:evenodd;"/>
        	            </svg>
        	        </label>
        	    </div>
            </div>
            <div class="image-file">
                <input type="file" accept="image/*" onchange="fileLoader(event)"
                       class="form-control-file"
                       id="image" name="image" value="{{ image_file }}" hidden>
                <label class="btn-main" for="image">
                    <img class="side-image" id="image_output" width="100%" height="100%"
                         src="{{ image_start_preview }}">
                </label>
            </div>
        </div>
    </div>
    {{ form.submit(type="button", class="btn btn-main", id="submit-button") }}
</form>
<script type="text/javascript" src="../static/data_parser.js"></script>
<script>
    var fileLoader = function(event) {
        var output = document.getElementById("image_output");
        output.src = URL.createObjectURL(event.target.files[0]);
        output.onload = function() {
            URL.revokeObjectURL(output.src);
        }
    };

    function audioButtonClick(event){
        console.log("audioButtonClicked");
        if (!audio_file.paused){audio_file.pause(); audio_file.currentTime = 0;}
        else {audio_file.play();}
        audio_playing = !audio_playing;
    }

    var audio_file;
    var audio_playing = false;
    const blob = window.URL || window.webkitURL;
    if (!blob) {
        alert("Ваш браузер не позволяет загрузить аудиофайл.");
    }

    input = document.getElementById("hieroglyph");
    input.value = "{{ prev_hieroglyph }}";
    input = document.getElementById("translation");
    input.value = "{{ prev_translation }}";
    input = document.getElementById("transcription");
    input.value = "{{ prev_transcription }}";
    input = document.getElementById("phrase_ch");
    input.value = "{{ prev_phrase_ch }}";
    input = document.getElementById("phrase_ru");
    input.value = "{{ prev_phrase_ru }}";

    is_transcription_audio = '{{ is_transcription_audio }}';
    is_phrase_audio = '{{ is_phrase_audio }}';
    is_translation_audio = '{{ is_translation_audio }}';
    no_value_color = "red";
    value_color = "green";

    transcription_audio = document.getElementById("transcription_audio");
    transcription_audio.addEventListener('change', function(event){
        var file = this.files[0],
        fileURL = blob.createObjectURL(file);
        console.log(file);
        console.log('File name: '+file.name);
        console.log('File type: '+file.type);
        console.log('File BlobURL: '+ fileURL);
        document.getElementById('transcription_audio_play').src = fileURL;
    });
    document.getElementById('transcription_audio_play').src = "/static/words_data/" + "{{ prev_transcription_audio }}";
    translation_audio_delete_button = document.getElementById("translation_audio-delete-button");
    translation_audio_delete_button.addEventListener('click', function(event){
        // var file = this.files[0],
        // fileURL = blob.createObjectURL(file);
        document.getElementById('translation_audio_delete_input').value = "a";
    });
    /*
    audio_file = new Audio("/static/words_data/" + "{{ prev_transcription_audio }}");
    audio_but = document.getElementById("audio_but");
    audio_but.addEventListener("click", audioButtonClick, false);
    transcription_audio.value = audio_file;
    */

    /*
    translation_audio = document.getElementById("translation_audio");
    translation_audio.addEventListener("change", function(event){
        button = document.getElementById("translation_audio_button");
        val = translation_audio.value;
        image = document.getElementById("left_output");
        if (val != ""){
            button.style = "min-width: 75px; min-height: 75px; background-color: green;";
        } else {
            button.style = "min-width: 75px; min-height: 75px; background-color: red;";
        }
    }, false);
    button = document.getElementById("translation_audio_button");
    image = document.getElementById("left_output");
    if (((translation_audio.value != "")  || (is_translation_audio)) == 'true'){
        button.style = "min-width: 75px; min-height: 75px; background-color: green;";
    } else {
        button.style = "min-width: 75px; min-height: 75px; background-color: red;";
    }
    */
    /*
    phrase_audio = document.getElementById("phrase_audio");
    image = document.getElementById("up_output");
    phrase_audio.addEventListener("change", function(event){
        button = document.getElementById("phrase_audio_button");
        image = document.getElementById("up_output");
        if (phrase_audio.value != "" || is_phrase_audio){
            button.style = "min-width: 75px; min-height: 75px; background-color: green;";
        } else {
            button.style = "min-width: 75px; min-height: 75px; background-color: red;";
        }
    }, false);
    button = document.getElementById("phrase_audio_button");
    image = document.getElementById("up_output");
    if (((phrase_audio.value != "")  || (is_phrase_audio)) == 'true'){
        button.style = "min-width: 75px; min-height: 75px; background-color: green;";
    } else {
        button.style = "min-width: 75px; min-height: 75px; background-color: red;";
    }
    */
    function checkWordUniqueness() {
        var python_data = {{ python_data|tojson }};
    	all_words = python_data.json_all_words;
    	hieroglyph = document.getElementById("hieroglyph").value;
    	translation = document.getElementById("translation").value;
    	res = 0;
    	for (var i = 0; i < all_words.length; i++) {
    		if (hieroglyph == all_words[i]["hieroglyph"] && translation == all_words[i]["translation"]){
    			res = Math.max(3, res);
    		} else if (hieroglyph == all_words[i]["hieroglyph"]){
    			res = Math.max(2, res);
    		} else if (translation == all_words[i]["translation"]){
    			res = Math.max(1, res);
    		}
    	}
    	return res;
    }

    function submitButtonClick(event){
    	if (checkWordUniqueness() == 0) {
    		document.getElementById("submit-button").type = "submit";
    	} else {
    		if (checkWordUniqueness() == 2){
    			message = "Слово с таким иероглифом уже существует. Вы действительно хотите создать новую запись для этого иероглифа?"
    		} else if (checkWordUniqueness() == 1) {
    			message = "Слово с таким переводом уже существует. Вы действительно хотите создать новую запись для этого перевода?"
    		} else if (checkWordUniqueness() == 3) {
    			message = "Слово с таким иероглифом и переводом уже существует. Вы действительно хотите создать новую запись для этого слова?"
    		} 
    		var retVal = confirm(message);
            if( retVal == true ) {
              	document.getElementById("submit-button").type = "submit";
            } else {
                document.getElementById("submit-button").type = "button";
            }
    	}
    }
    document.getElementById("submit-button").addEventListener("click", submitButtonClick, false);
</script>
{% endblock %}
